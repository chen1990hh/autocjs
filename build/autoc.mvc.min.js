/* 
 AutocJS - Automatically create directory navigation for your article. 
 Copyright (c) 2016 yaohaixiao, all right reserved. 
 homepage: https://github.com/yaohaixiao/AutocJS/#readme 
 version: 1.0.1 
 author: yaohaixiao  
 license: MIT 
 */
!function(a,b){"use strict";"function"==typeof define&&define.amd?define("autocjs",["jquery"],b(a,$)):"function"==typeof define&&define.cmd?define("autocjs",function(c,d,e){e.exports=b(a,c("jquery"))}):"object"==typeof exports?module.exports=b(a,require("jquery")):b(a,jQuery)}("undefined"!=typeof window?window:this,function(a,b){"use strict";function c(a){return a.replace(new RegExp(o,"img"),"")}function d(a){return a.replace(/[\r\t\n]/g," ").replace(/[&<>"'\/`]/g,function(a){return n[a]})}function e(a){return a.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&#x2F;/g,"/").replace(/&#x60;/g,"`")}function f(a){return e(d(c(a)))}function g(a){var b,c=a.data,d=a.html,e=a.startTag||"{",g=a.endTag||"}";d+="";for(b in c)d=d.replace(new RegExp(e+b+g,"img"),f(c[b]));return f(d)}function h(a){return p+=1,a?a+"-"+p:p}function i(a){return a&&("object"==typeof a||b.isFunction(a))||!1}function j(a){var c=[],d=1,e=0;return b(a).each(function(a,f){var g=b(f),h=g.text(),i=parseInt(g[0].tagName.toUpperCase().replace(/[H]/gi,""),10),j=-1;i>d?(e+=1,j=1===e?-1:a-1):i===d||i<d&&i>e?1===i?(e=1,j=-1):j=c[a-1].pid:i<=e&&(1===i?e=1:e-=d-i,j=1===e?-1:m(c,d-i,a)),d=i,c.push({id:a,level:e,text:h,tag:f.tagName,pid:j})}),c}function k(a,c){var d=[];return b(a).each(function(a,e){var f=e.id,g=b(c).attr({id:s+"-"+f,href:"#"+r+"-"+f,"aria-label":e.text}).addClass(s).addClass(B);d.push(g)}),d}function l(a){var c={},d=[];return b(a).each(function(a,b){var d=b.pid===-1?"H1":b.pid.toString();c[d]||(c[d]=[])}),b.each(c,function(e){b(a).each(function(a,b){var d=b.pid===-1?"H1":b.pid.toString();e===d&&c[e].push(b)}),d.push(c[e])}),d}function m(a,b,c){var d=-1;switch(b){case 1:d=a[a[c-1].pid].pid;break;case 2:d=a[a[a[c-1].pid].pid].pid;break;case 3:d=a[a[a[a[c-1].pid].pid].pid].pid;break;case 4:d=a[a[a[a[a[c-1].pid].pid].pid].pid].pid;break;case 5:d=a[a[a[a[a[a[c-1].pid].pid].pid].pid].pid].pid;break;default:d=a[a[c-1].pid].pid}return d}var n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;","`":"&#x60;"},o="<script[^>]*>([\\S\\s]*?)</script\\s*>",p=-1,q="article-",r="autocjs-heading",s="autocjs-anchor",t="autocjs",u="autocjs-chapters",v=q+u,w="autocjs-subjects",x="autocjs-chapter",y="autocjs-text",z="autocjs-code",A="autocjs-show",B="autocjs-hide",C='<a class="'+s+'" aria-hidden="true"></a>',D='<div id="{id}" class="'+t+" "+B+'" aria-hidden="true"></div>',E='<h2 class="autocjs-hd" aria-hidden="true">{title}</h2>',F='<nav class="autocjs-bd" aria-hidden="true"></nav>',G='<ol class="'+u+'" aria-hidden="true"></ol>',H='<ol class="'+w+'" aria-hidden="true"></ol>',I='<li class="'+x+'" aria-hidden="true"></li>',J='<a class="'+y+'" aria-hidden="true"></a>',K='<em class="'+z+'" aria-hidden="true"></em>',L='<div class="autocjs-ft" aria-hidden="true"></div>',M='<h2 class="autocjs-switcher" title="Toggle Menu" aria-hidden="true">&#926;</h2>',N='<a class="autocjs-top" href="#top" aria-hidden="true">TOP</a>',O='<div class="autocjs-overlay '+B+'" aria-hidden="true"></div>',P="h1,h2,h3,h4,h5,h6",Q=function(a){return this.model=new Q.Model,this.view=new Q.View,this.controller=new Q.Controller,b.isPlainObject(a)&&this.initialize(a),this};return Q.prototype={version:"1.0.1",initialize:function(a){var b=this.model.initialize(a),c=this.view.initialize(b);return this.controller.initialize(b,c),this.render().trigger(),this},chapters:function(a){return this.model.chapters(a)},list:function(){return this.model.list()},reload:function(a){return this.destroy().initialize(b.extend(this.model.attributes,a)),this},render:function(){return this.view.render(),this},destroy:function(){return this.view.destroy(),this},trigger:function(){return this.controller.trigger(),this}},Q.Model=function(a){return this.attributes={},this.elements={article:null,headings:null,chapters:null,wrap:null,header:null,body:null,list:null,footer:null,switcher:null,top:null,overlay:null},this.data={chapters:[],anchors:[],list:[]},this.set(Q.defaults),b.isPlainObject(a)&&this.initialize(a),this},Q.Model.prototype={version:"1.0.1",initialize:function(a){return b.isPlainObject(a)&&this.set(a),this.initializeDOM().initializeData(),this},initializeDOM:function(){var a=this,c=this.dom();return c.article=b(this.get("article")),c.headings=c.article.find(this.get("selector")),c.chapters=b(this.get("CHAPTERS")).addClass(v),c.wrap=b(g({data:{id:h(t)},html:a.get("WRAP")})),c.header=b(g({data:{title:a.get("title")},html:a.get("HEADER")})),c.body=b(this.get("BODY")),c.list=b(this.get("CHAPTERS")),c.footer=b(this.get("FOOTER")),c.switcher=b(this.get("SWITCHER")),c.top=b(this.get("TOP")),c.overlay=b(this.get("OVERLAY")),this},initializeData:function(){var a=this.dom();return this.data.chapters=j(a.headings),this.data.anchors=k(this.chapters(),this.get("ANCHOR")),this.data.list=l(this.chapters()),this},set:function(a){return b.isPlainObject(a)&&b.extend(this.attributes,a),this},get:function(a){return this.attributes[a]},dom:function(){return this.elements},chapters:function(a){return a?(this.data.chapters=j(a),this):j(this.dom().headings)},anchors:function(){return this.data.anchors},list:function(){return this.data.list},getChapterIndex:function(a){var c=-1;return b(this.list()).each(function(d,e){b(e).each(function(b,d){if(d===a)return c=b,!1})}),c}},Q.View=function(a){return this.model=null,i(a)&&this.initialize(a),this},Q.View.prototype={version:"1.0.1",initialize:function(a){return a&&(this.model=a),this},render:function(){return this.renderArticleDirectory().renderAnchors().renderSidebarDirectory(),this},renderArticleDirectory:function(){var a=this.model,c=a.dom(),d=b(c.article[0].firstChild);return a.get("hasDirectoryInArticle")?(c.chapters.insertBefore(d),this.renderArticleChapters(),this):this},renderArticleChapters:function(){var a=this.model;return a.get("hasDirectoryInArticle")&&this.renderChapters(a.dom().chapters),this},renderAnchors:function(){var a=this,c=this.model,d=c.dom(),e=d.headings,f=c.anchors();return b(c.chapters()).each(function(c,d){var g=r+"-"+d.id,h=b(e[c]),i=h.find("#"+g),j=b(f[c]);i[0]&&i.remove(),h.attr("id",g).addClass(r).append(j),a.renderHeadingChapterCode(d)}),this},renderHeadingChapterCode:function(a){var c,d,e,f=q+z,g=this.model,h=a.pid,i=a.id,j=a.tag,k=b("#"+r+"-"+i),l=k.find("#"+f+"-"+i);return l[0]&&l.remove(),g.get("hasChapterCodeAtHeadings")&&"H1"!==j?(c=b(g.get("CODE")).attr("id",f+"-"+i),e=g.getChapterIndex(a)+1,d=h===-1&&"H2"===j?e:b("#"+f+"-"+h).html()+"."+e,c.attr("data-chapter",d).html(d),c.insertBefore(k[0].firstChild),this):this},renderSidebarDirectory:function(){var a=this.model;return a.get("isAnchorsOnly")?this:(this.renderSidebarOutline().renderSidebarChapters(),a.dom().wrap.removeClass(B),this.updateLayout(),this)},renderSidebarOutline:function(){var a=this.model,c=a.dom(),d=c.wrap,e=c.footer,f=b(document.body);return a.get("isAnchorsOnly")?this:(e.append(c.switcher).append(c.top),c.body.append(c.list),d.empty().append(c.header).append(c.body).append(e),f.append(d).append(c.overlay),a.get("isAnimateScroll")||f.attr("id","top"),this)},renderSidebarChapters:function(){var a=this.model;return a.get("isAnchorsOnly")||this.renderChapters(a.dom().list),this},renderChapters:function(a){var c=this.model,d=b(a),e=c.chapters();return d.empty(),b(e).each(function(a,e){var f,g,h,i,j,k,l,m=e.pid,n=e.id,o=r+"-"+n,p=null,s=b(c.get("CHAPTER")),t=b(c.get("CODE")),u=b(c.get("TEXT"));d.hasClass(v)?(i=q+y+"-"+n,j=q+x+"-"+n,k=q+w+"-"+m,l=q+x+"-"+m):(i=y+"-"+n,j=x+"-"+n,k=w+"-"+m,l=x+"-"+m),h=b("#"+k),u.attr({id:i,href:"#"+o,rel:o}).html(e.text),s.attr({id:j,title:e.text}).append(u),e.pid===-1?(d.append(s),g=s.index()+1,f=g):(p=b("#"+l),h[0]||(h=b(c.get("SUBJECTS")).attr("id",k),p.append(h)),h.append(s),g=s.index()+1,f=p.find("."+z).html()+"."+g),t.attr("data-chapter",f).html(f),t.insertBefore(u)}),this},show:function(){var a=this.model.dom(),b=a.wrap;return a.overlay.removeClass(B),b.animate({left:0},150,function(){b.addClass(A)}),this},hide:function(){var a=this.model.dom(),b=a.wrap;return b.animate({left:-300},150,function(){a.overlay.addClass(B),b.removeClass(A)}),this},toggle:function(){return this.model.dom().wrap.hasClass(A)?this.hide():this.show(),this},updateLayout:function(){var a=this.model.dom(),b=a.wrap[0].offsetHeight,c=a.header[0].offsetHeight;return a.body.height(b-c),this},scrollTo:function(a){var c=this;return b("html,body").animate({scrollTop:a},500,"linear",function(){c.hide()}),this},destroy:function(){var c=this.model,d=c.dom(),e=c.anchors(),f=d.headings,g=d.article,h=d.chapters,i=d.wrap,j=d.overlay;return g.off(),h.remove(),b(f).each(function(a,c){var d=b(c),f=d.find("."+z);d.removeClass(r).removeAttr("id"),f.remove(),e[a].remove()}),i.off().remove(),j.off().remove(),b(a).off("resize",this.onWindowResize),this}},Q.Controller=function(a,b){return this.model=null,this.view=null,i(a)&&i(b)&&this.initialize(a,b),this},Q.Controller.prototype={version:"1.0.1",initialize:function(a,b){return i(a)&&(this.model=a),i(b)&&(this.view=b),this},trigger:function(){var c,d,e=this,f=this.model,g={context:e};return c=f.dom(),d=c.article,d.delegate("."+r,"mouseenter",g,this.onHeadingMouseEnter),d.delegate("."+r,"mouseleave",g,this.onHeadingMouseLeave),f.get("hasDirectoryInArticle")&&d.delegate("."+y,"click",g,this.onArticleChapterClick),f.get("isAnchorsOnly")||(c.switcher.on("click",g,this.onSwitcherClick),c.top.on("click",g,this.onTopClick),c.list.delegate("."+y,"click",g,this.onSidebarChapterClick),c.overlay.on("click",g,this.onOverlayClick),b(a).on("resize",g,this.onWindowResize)),this},onHeadingMouseEnter:function(a){var c=a.data.context,d=b(this).find("."+s);return d.removeClass(B),c},onHeadingMouseLeave:function(a){var c=a.data.context,d=b(this).find("."+s);return d.addClass(B),c},onArticleChapterClick:function(a){var c=a.data.context,d=c.get("isAnimateScroll"),e=b("#"+b(this).attr("rel"));return d&&(c.view.scrollTo(e[0].offsetTop),a.stopPropagation(),a.preventDefault()),c},onSwitcherClick:function(a){var b=a.data.context;return b.view.toggle(),a.stopPropagation(),a.preventDefault(),b},onTopClick:function(a){var b=a.data.context,c=b.get("isAnimateScroll");return c?(b.view.scrollTo(0),a.stopPropagation(),a.preventDefault()):b.hide(),b},onSidebarChapterClick:function(a){var c=a.data.context,d=c.model.get("isAnimateScroll"),e=b("#"+b(this).attr("rel"));return d?(c.view.scrollTo(e[0].offsetTop),a.stopPropagation(),a.preventDefault()):c.view.hide(),c},onOverlayClick:function(a){var b=a.data.context;return b.view.hide(),a.stopPropagation(),a.preventDefault(),b},onWindowResize:function(a){var b=a.data.context;return b.updateLayout(),b}},Q.defaults={article:"",selector:P,title:"Table of Contents",isAnchorsOnly:!1,isAnimateScroll:!0,hasDirectoryInArticle:!1,hasChapterCodeAtHeadings:!1,ANCHOR:C,WRAP:D,HEADER:E,BODY:F,FOOTER:L,SWITCHER:M,TOP:N,CHAPTERS:G,SUBJECTS:H,CHAPTER:I,TEXT:J,CODE:K,OVERLAY:O},Q.stripScripts=c,Q.encodeHTML=d,Q.decodeHTML=e,Q.safetyHTML=f,Q.template=g,Q.guid=h,b.extend(b.fn,{autoc:function(a){var c=b(this),d={};return b.extend(d,a,{article:c}),new Q(d)}}),a.AutocJS=Q,Q});